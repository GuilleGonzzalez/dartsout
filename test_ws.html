<!doctype html>

<h1>Dartsout test</h1>

<input type="text" id="player_name" placeholder="Player name" maxlength="50">
<button onclick="new_player()">Add player</button>

<br>

<button onclick="new_game()">New game</button>

<br>

<input type="text" id="num" placeholder="dart number" maxlength="2">
<button onclick="new_dart(0)">Triple shot</button>
<button onclick="new_dart(1)">Double shot</button>
<button onclick="new_dart(2)">Single shot</button>

<br>

<form name="publish">
  <input type="text" name="message" maxlength="50"/>
  <input type="submit" value="Send"/>
</form>

<div id="messages"></div>


<script>

let ws_url = "ws://localhost:8000/websocket"
let socket = new WebSocket(ws_url);

document.forms.publish.onsubmit = function() {
  let outgoingMessage = this.message.value;

  socket.send(outgoingMessage);
  return false;
};

socket.onmessage = function(event) {
  let incomingMessage = event.data;
  showMessage(incomingMessage);
};

socket.onclose = event => console.log(`Closed ${event.code}`);


function showMessage(message) {
  let messageElem = document.createElement('div');
  messageElem.textContent = "MSG rvc: " + message;
  let json;
  try {
    json = JSON.parse(message);
  } catch {
    json = message;
  }
  console.log("Round: " + json["round"] + "/" + json["max_round"])
  console.log("Name: " + json["name"] + ", dart: " + json["darts"])
  console.log("Score: " + json["game_score"] + " (current: " + json["round_score"] + ")")
  document.getElementById('messages').prepend(messageElem);
}

function api_post(url, json) {
  fetch(url, {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: json,
  })
  .then(response => response.json())
  .then(data => {
      console.log('API response:', data);
  })
  .catch(error => {
      console.error('API error:', error);
  });
}

function new_dart(zone) {
  const board_id = 1;
  const num = parseInt(document.getElementById('num').value);
  json = JSON.stringify({board_id, num, zone})
  api_post("/new-dart", json) 
}

function new_player() {
  const player = document.getElementById('player_name').value;
  json = JSON.stringify({player})
  api_post("/new-player", json) 
}

function new_game() {
  const game = 0;
  json = JSON.stringify({game})
  api_post("/new-game", json) 
}

</script>
